<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>家庭功能量表 · 手机即时评分</title>
  <style>
    :root{--radius:16px;--border:#e5e7eb;--text:#111827;--muted:#6b7280;--bg:#f9fafb}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:860px;margin:0 auto;padding:16px;background:var(--bg);color:var(--text);line-height:1.5}
    h1{font-size:22px;margin:8px 0 4px}
    .muted{color:var(--muted)}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin:12px 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,input,button{font:inherit}
    button{padding:12px 16px;border-radius:12px;border:1px solid #111;background:#111;color:#fff}
    button.secondary{background:#fff;color:#111;border-color:#ddd}
    .q{margin:10px 0}
    .q h3{font-size:16px;margin:0 0 8px}
    .opt{display:flex;gap:8px;align-items:center;margin:6px 0}
    .bar{height:10px;border-radius:999px;background:#eef2ff;position:relative;overflow:hidden}
    .bar>i{display:block;height:100%;background:#111}
    .grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    details summary{cursor: pointer}
    .footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
    .tag{display:inline-block;background:#eef2ff;border:1px solid #dbeafe;color:#1e3a8a;padding:2px 8px;border-radius:999px;font-size:12px}
    .pill{display:inline-block;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px}
    .k{font-weight:600}
    @media (prefers-color-scheme: dark){
      :root{--border:#374151;--text:#f3f4f6;--muted:#9ca3af;--bg:#0b0f14}
      .card{background:#0f141b}
      .bar{background:#0b1020}
      .bar>i{background:#e5e7eb}
      button.secondary{color:#e5e7eb;border-color:#374151}
    }
  </style>
</head>
<body>
  <header class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>家庭功能量表 · 即时评分</h1>
        <div class="muted">单机本地计算，不上传；提交后立即得到个人分数与解释。</div>
      </div>
      <div>
        <span class="tag" id="versionTag">v1.0</span>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="pill">选择量表：
        <select id="presetSelect" style="border:none;background:transparent;outline:none">
  <option value="FAD60">FAD-60（正式量表，四点计分）</option>
  <option value="APGAR">APGAR-5（0–10分）</option>
  <option value="FAD12">FAD-12 简版（1–4分×12题）</option>
</select>
      </label>
      <button class="secondary" id="btnReset">清空作答</button>
    </div>
  </header>

  <form id="form" class="card" novalidate>
    <div id="intro" class="muted" style="margin-bottom:8px"></div>
    <div id="items"></div>
    <div class="row" style="margin-top:8px">
      <button type="button" id="btnSubmit">提交并查看结果</button>
      <button type="button" class="secondary" id="btnCopy">复制结果文本</button>
    </div>
  </form>

  <section id="out" class="card" style="display:none">
    <h2 style="margin:0 0 6px">我的测评结果</h2>
    <div class="grid">
      <div class="muted">总分</div>
      <div id="totalScore" class="k" style="text-align:right"></div>
      <div class="muted">结论</div>
      <div id="totalLabel" style="text-align:right"></div>
    </div>
    <div id="advice" class="card" style="margin-top:10px"></div>

    <div id="domainsWrap" style="display:none;margin-top:8px">
      <h3 style="margin:0 0 6px">分维度</h3>
      <div id="domains"></div>
    </div>

    <details style="margin-top:10px">
      <summary>查看我的作答</summary>
      <pre id="answers" style="white-space:pre-wrap"></pre>
    </details>
  </section>

  <div class="footer">© 本页仅用于课堂演示；结果仅供教育参考，不构成诊断。</div>

<script>
// ================= 配置两套「预设量表」 =================
const PRESETS = {
  // APGAR 省略（仍保留）
  APGAR: PRESETS?.APGAR || {
    title: '家庭功能量表 APGAR（5题）',
    intro: '5个条目，每题0–2分；总分0–10分。',
    options: [
      {label:'从不/很少', score:0},
      {label:'有时', score:1},
      {label:'经常/总是', score:2},
    ],
    items: [
      {text:'我对家庭成员提供的帮助程度感到满意（A）', reverse:false, domain:'适应 A'},
      {text:'我与家庭成员能协商并共同决策（P）', reverse:false, domain:'合作 P'},
      {text:'家庭能支持我的个人成长（G）', reverse:false, domain:'成长 G'},
      {text:'我在家庭中能感到爱与关怀（A）', reverse:false, domain:'情感 A'},
      {text:'家人能与我一起安排与度过时间（R）', reverse:false, domain:'决策 R'},
    ],
    totalInterpret: [
      {min:7, label:'功能良好', advice:'维持有效沟通与支持，保持共同活动与情感表达。'},
      {min:4, label:'轻-中度功能受损', advice:'可尝试家庭会议、明确分工与情绪表达练习。'},
      {min:-Infinity, label:'中-重度功能受损', advice:'建议联系学校辅导/专业机构做进一步评估与支持。'},
    ],
    domainInterpret: {}
  },

  // FAD-12（保留示例）
  FAD12: PRESETS?.FAD12 || {
    title: 'FAD-12 家庭功能简式（12题）',
    intro: '12个条目，1–4分（非常不同意=1 → 非常同意=4）。部分为反向计分，系统已自动处理。',
    options: [
      {label:'非常不同意', score:1},
      {label:'不同意', score:2},
      {label:'同意', score:3},
      {label:'非常同意', score:4},
    ],
    items: [],
    totalInterpret: [
      {min:42, label:'整体功能良好', advice:'维持积极的沟通与规则，一起规划有质量的家庭时间。'},
      {min:30, label:'轻度受损', advice:'建议在冲突管理与角色明确上做小幅改进。'},
      {min:-Infinity, label:'中-重度受损', advice:'建议寻求校园/专业支持，开展沟通与问题解决训练。'},
    ],
    domainInterpret: {}
  },

  // ===== 核心：FAD-60（四点计分，低分=更健康；含7个分量表） =====
  FAD60: {
    title: 'McMaster 家庭功能评定量表 FAD-60（正式量表）',
    intro: '60个条目，四点计分：很像我家=1，像我家=2，不像我家=3，完全不像我家=4。低分=更健康；含7个分量表（PS/CM/RL/AR/AI/BC/GF）。带 * 的条目为反向计分，系统自动换向。',
    options: [
      {label:'很像我家', score:1},
      {label:'像我家', score:2},
      {label:'不像我家', score:3},
      {label:'完全不像我家', score:4},
    ],
    items: [
      // 下面的清单由你上传的Excel自动抽取（含反向与分量表归属）
      {text:'由于我们彼此误解，难于安排一些家庭活动。', reverse:true, domain:'总的功能'},
      {text:'我们在住处附近解决大多数日常问题。', reverse:false, domain:'问题解决'},
      {text:'当家中有人烦恼时，其他人知道他为什么烦恼。', reverse:false, domain:'沟通'},
      {text:'当你要求某人去做某事时，你必须检查他们是否做了。', reverse:true, domain:'家庭角色分工'},
      {text:'如果某人遇到麻烦时，其他人会过份关注。', reverse:true, domain:'行为控制'},
      {text:'发生危机时，我们能相互支持。', reverse:false, domain:'总的功能'},
      {text:'当发生了出乎预料的意外时，我们手足无措。', reverse:true, domain:'情感参与'},
      {text:'我们家时常把我们所需要的东西用光了。', reverse:true, domain:'家庭角色分工'},
      {text:'我们相互都不愿流露出自己的感情。', reverse:true, domain:'情感反应'},
      {text:'我们肯定家庭成员都尽到了各自的家庭职责。', reverse:false, domain:'家庭角色分工'},
      {text:'我们不能相互谈论我们的忧愁。', reverse:true, domain:'总的功能'},
      {text:'我们常根据我们对问题的决定去行动。', reverse:false, domain:'问题解决'},
      {text:'你的事只有对别人也重要时，他们才会感兴趣。', reverse:false, domain:'家庭角色分工'},
      {text:'从那些人正在谈的话中，你不明白其中一个人是怎么了。', reverse:true, domain:'沟通'},
      {text:'家务事没有由家庭成员充分分担。', reverse:true, domain:'家庭角色分工'},
      {text:'每个人是什么样的，都能被别人认可。', reverse:false, domain:'总的功能'},
      {text:'当有人感到难受时，其他人总是试图原谅他。', reverse:false, domain:'沟通'},
      {text:'大家都把事情摆在桌面上说，而不用暗示的方法。', reverse:false, domain:'沟通'},
      {text:'我们会按照我们在家庭中各自所扮演的角色行事。', reverse:false, domain:'家庭角色分工'},
      {text:'我们经常改变我们对别人的行为原则。', reverse:false, domain:'行为控制'},
      {text:'我们难得相互说出温存的感受。', reverse:true, domain:'沟通'},
      {text:'我们彼此之间能共同商定谁应做什么。', reverse:false, domain:'问题解决'},
      {text:'我们对家人如何穿衣打扮没有一定的标准。', reverse:false, domain:'行为控制'},
      {text:'每个人都能在我们家庭中表达自己的意见。', reverse:false, domain:'总的功能'},
      {text:'我们能经常交谈我们每个人的希望与恐惧。', reverse:false, domain:'沟通'},
      {text:'计划家庭活动的责任分配明确。', reverse:false, domain:'家庭角色分工'},
      {text:'我们太以自我为中心了', reverse:true, domain:'情感参与'},
      {text:'我们能相互表达出自己的感受。', reverse:false, domain:'总的功能'},
      {text:'我们对梳妆服饰习惯无明确要求。', reverse:true, domain:'家庭角色分工'},
      {text:'我们彼此间不表示爱意', reverse:true, domain:'情感反应'},
      {text:'我们对人说话都直说，而不转弯抹角', reverse:false, domain:'沟通'},
      {text:'我们每个人都有特定的任务和职责', reverse:false, domain:'家庭角色分工'},
      {text:'家庭的情绪气氛很不好。', reverse:true, domain:'情感反应'},
      {text:'我们有惩罚人的原则。', reverse:false, domain:'家庭角色分工'},
      {text:'只有当某事使我们都感兴趣时，我们才一起参加。', reverse:true, domain:'情感参与'},
      {text:'没有时间去做自己感兴趣的事。', reverse:true, domain:'情感参与'},
      {text:'我们常不把自己的想法说出来。', reverse:true, domain:'沟通'},
      {text:'我们感到我们能被别人容忍。', reverse:false, domain:'总的功能'},
      {text:'我们在住处附近解决大多数日常问题。', reverse:false, domain:'问题解决'},
      {text:'在我们家，亲密和温存居次要地位。', reverse:true, domain:'问题解决'},
      {text:'我们能解决大多数情绪上的烦恼。', reverse:false, domain:'情感反应'},
      {text:'我们讨论谁做家务。', reverse:false, domain:'情感参与'},
      {text:'在我们家对事情作出决定是困难的。', reverse:true, domain:'总的功能'},
      {text:'我们家的人只有在对自己有利时，才彼此关照。', reverse:true, domain:'情感参与'},
      {text:'我们有一个明确的任务分配制度。', reverse:false, domain:'家庭角色分工'},
      {text:'我们镇静地面对涉及感情的问题。', reverse:false, domain:'问题解决'},
      {text:'我们不遵从任何规则和标准。', reverse:true, domain:'行为控制'},
      {text:'如果原则被打破，我们不知道将会发生什么事．', reverse:false, domain:'行为控制'},
      {text:'在我们家任何事都行得通。', reverse:true, domain:'行为控制'},
      {text:'我们不能和睦相处。', reverse:true, domain:'总的功能'},
      {text:'我们有应付危险情况的原则。', reverse:false, domain:'行为控制'},
      {text:'我们相互信赖。', reverse:false, domain:'总的功能'},
      {text:'我们当众哭出声来。', reverse:false, domain:'情感反应'},
      {text:'我们没有合适的交通工具。', reverse:true, domain:'家庭角色分工'},
      {text:'当我们不喜欢有的人的所作所为时，我们就会给他指出来。', reverse:false, domain:'沟通'},
      {text:'我们想尽各种办法来解决问题。', reverse:false, domain:'问题解决'},
    ],
    // 解释：按平均分 1.0–4.0，分数越高=功能越差；阈值来自文献（见课堂讲义/参考文献）
    // Frontiers in Psychology (2023) 等研究常用 cut-off：PS>2.20, CM>2.20, RL>2.30, AR>2.20, AI>2.10, BC>1.90, GF>2.00
    cutoffs: { PS:2.20, CM:2.20, RL:2.30, AR:2.20, AI:2.10, BC:1.90, GF:2.00 },
  }
};

// ================= 渲染 & 逻辑 =================
const els = {
  presetSelect: document.getElementById('presetSelect'),
  btnReset: document.getElementById('btnReset'),
  form: document.getElementById('form'),
  items: document.getElementById('items'),
  intro: document.getElementById('intro'),
  out: document.getElementById('out'),
  totalScore: document.getElementById('totalScore'),
  totalLabel: document.getElementById('totalLabel'),
  advice: document.getElementById('advice'),
  domainsWrap: document.getElementById('domainsWrap'),
  domains: document.getElementById('domains'),
  answers: document.getElementById('answers'),
  btnSubmit: document.getElementById('btnSubmit'),
  btnCopy: document.getElementById('btnCopy'),
};

let CURRENT = PRESETS.APGAR;
let radioNameSeed = 1;

function render(){
  els.intro.textContent = CURRENT.intro;
  els.items.innerHTML = '';
  radioNameSeed++;
  CURRENT.items.forEach((q, idx)=>{
    const wrap = document.createElement('div');
    wrap.className = 'q card';
    const h = document.createElement('h3');
    h.textContent = `Q${idx+1}. ${q.text}`;
    wrap.appendChild(h);

    CURRENT.options.forEach((opt,j)=>{
      const id = `q${radioNameSeed}_${idx}_${j}`;
      const label = document.createElement('label');
      label.className = 'opt';
      label.htmlFor = id;
      label.innerHTML = `<input required type="radio" name="q_${radioNameSeed}_${idx}" id="${id}" value="${opt.score}"> <span>${opt.label}</span>`;
      wrap.appendChild(label);
    });

    els.items.appendChild(wrap);
  });
  els.out.style.display = 'none';
}

function interpretFrom(rules, score){
  for(const r of rules){ if(score >= r.min) return {label:r.label, advice:r.advice||''}; }
  return {label:'', advice:''};
}

function calc(){
  let total = 0; const answers = []; const domains = new Map();
  for(let i=0;i<CURRENT.items.length;i++){
    const sel = /** @type {HTMLInputElement|null} */(document.querySelector(`input[name="q_${radioNameSeed}_${i}"]:checked`));
    if(!sel){ alert(`第 ${i+1} 题未作答`); return null; }
    let s = parseFloat(sel.value);
    if(CURRENT.items[i].reverse){
      const min = Math.min(...CURRENT.options.map(o=>o.score));
      const max = Math.max(...CURRENT.options.map(o=>o.score));
      s = max - (s - min); // 线性反转到同向
    }
    total += s;
    answers.push({idx:i+1, score:s});
    const dom = CURRENT.items[i].domain || '总分';
    const prev = domains.get(dom)||0; domains.set(dom, prev + s);
  }
  return {total, answers, domains};
}

function percent(v, max){ return Math.max(0, Math.min(100, Math.round(v/max*100))); }

function showResult(data){
  const maxPerItem = Math.max(...CURRENT.options.map(o=>o.score));
  const entries = [...data.domains.entries()];

  // ==== FAD60: 按平均分（1-4）展示，并与cutoff比较 ====
  if (CURRENT.cutoffs){
    // 计算各维度均值
    const counts = {};
    CURRENT.items.forEach(it=>{ counts[it.domain] = (counts[it.domain]||0)+1; });

    // 总的功能（GF）
    const gfScore = (data.domains.get('总的功能')||0) / (counts['总的功能']||1);
    const gfCut = CURRENT.cutoffs.GF;
    const gfLabel = gfScore > gfCut ? '可能功能受损' : '功能较好';

    els.totalScore.textContent = gfScore.toFixed(2) + '（均值，1–4）';
    els.totalLabel.textContent = `GF：${gfLabel}（阈值>${gfCut.toFixed(2)}）`;
    els.advice.textContent = gfLabel==='可能功能受损'
      ? '结果提示：您的家庭在总体功能上表现出一定程度的挑战，建议在沟通与问题解决方面给予更多关注，如有需要可寻求专业人士的进一步支持。'
      : '结果提示：您的家庭总体功能处于良好水平，建议继续保持积极的互动与支持模式。';

    // 分维度
    els.domainsWrap.style.display = '';
    els.domains.innerHTML = '';
    const nameMap = { '问题解决':'PS', '沟通':'CM', '家庭角色分工':'RL', '情感反应':'AR', '情感参与':'AI', '行为控制':'BC', '总的功能':'GF' };
    entries.forEach(([name,score])=>{
      const n = counts[name]||1; const mean = score / n; const code = nameMap[name];
      const cut = CURRENT.cutoffs[code] ?? CURRENT.cutoffs[name] ?? 0;
      const label = mean > cut ? '提示：该维度可能存在一定功能挑战' : '提示：该维度功能处于良好水平';
      const maxDom = maxPerItem * n;
      const row = document.createElement('div'); row.className='card';
      row.innerHTML = `
        <div class="grid">
          <div class="k">${name}（${code||''}）</div>
          <div style="text-align:right">均值 ${mean.toFixed(2)} / 4</div>
        </div>
        <div class="bar" style="margin:6px 0 2px"><i style="width:${percent(score,maxDom)}%"></i></div>
        <div class="muted" style="text-align:right">${label}（阈值>${cut.toFixed(2)}）</div>
      `;
      els.domains.appendChild(row);
    });

  } else {
    // ==== 其他量表（按总分） ====
    const maxTotal = maxPerItem * CURRENT.items.length;
    const interp = interpretFrom(CURRENT.totalInterpret, data.total);
    els.totalScore.textContent = `${data.total} / ${maxTotal}`;
    els.totalLabel.textContent = interp.label;
    els.advice.textContent = interp.advice || '';

    // 分维度（如有）
    const entries2 = entries;
    if(entries2.length>1){
      els.domainsWrap.style.display = '';
      els.domains.innerHTML = '';
      entries2.forEach(([name,score])=>{
        const maxDom = maxPerItem * CURRENT.items.filter(it=>it.domain===name).length;
        const row = document.createElement('div'); row.className='card';
        row.innerHTML = `
          <div class="grid">
            <div class="k">${name}</div>
            <div style="text-align:right">${score} / ${maxDom}</div>
          </div>
          <div class="bar" style="margin:6px 0 2px"><i style="width:${percent(score,maxDom)}%"></i></div>
        `;
        els.domains.appendChild(row);
      });
    }else{
      els.domainsWrap.style.display = 'none';
    }
  }

  // 答案文本
  els.answers.textContent = data.answers.map(a=>`Q${a.idx}: ${a.score}分`).join('
');
  els.out.style.display = '';
}

function copyResult(){
  const txt = `【家庭功能量表结果】\n总分：${els.totalScore.textContent}（${els.totalLabel.textContent}）\n建议：${els.advice.textContent||'（无）'}\n——分维度——\n${[...document.querySelectorAll('#domains .card')].map(el=>{
    const name = el.querySelector('.k')?.textContent||'';
    const score = el.querySelector('.grid div:last-child')?.textContent||'';
    const lab = el.querySelector('.muted:last-child')?.textContent||'';
    return `${name}: ${score} ${lab? '（'+lab+'）':''}`;
  }).join('\n')}`;
  navigator.clipboard.writeText(txt).then(()=>{
    alert('结果已复制，可粘贴到聊天/便签');
  }, ()=>{
    alert('复制失败，可手动选择结果文本');
  });
}

// 事件绑定
els.presetSelect.addEventListener('change', ()=>{
  CURRENT = PRESETS[els.presetSelect.value];
  render();
});

// 默认选择FAD60
els.presetSelect.value = 'FAD60';
CURRENT = PRESETS.FAD60;
});

els.btnReset.addEventListener('click', ()=>{
  els.form.reset();
  els.out.style.display = 'none';
});

document.getElementById('btnSubmit').addEventListener('click', ()=>{
  const data = calc(); if(!data) return; showResult(data);
});

document.getElementById('btnCopy').addEventListener('click', copyResult);

// 初始
render();
</script>
</body>
</html>
